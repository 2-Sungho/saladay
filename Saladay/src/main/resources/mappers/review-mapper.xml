<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="reviewMapper">

<!-- Review resultMap -->
<resultMap type="Review" id="review_rm">
	<id property="reviewNo" column="REVIEW_NO"/>
	<result property="rating" column="RATING"/>
	<result property="reviewContent" column="REVIEW_CONTENT"/>
	<result property="reviewDate" column="REVIEW_DATE"/>
	<result property="reviewDeleteFlag" column="REVIEW_DEL_FL"/>
	<result property="memberNo" column="MEMBER_NO"/>
	<result property="memberNickname" column="MEMBER_NICKNAME"/>
	<result property="orderMenuNo" column="ORDER_MENU_NO"/>
	<result property="menuNo" column="MENU_NO"/>
	<result property="menuName" column="MENU_NAME"/>
	<result property="likeCount" column="LIKE_COUNT"/>
	<result property="likeCheck" column="LIKE_CHECK"/>
	<result property="thumbnail" column="THUMBNAIL"/>
	
	<!-- 리뷰 이미지 리스트 -->
<!-- 	   <collection property="imageList"
        javaType="java.util.ArrayList" ofType="ReviewImage"
        select="selectImageList"
        column="REVIEW_NO"/> -->
</resultMap>

<!-- ReviewImage resultMap -->
<resultMap type="ReviewImage" id="reviewImage_rm">
	   <id property="reviewImageNo" column="REVIEW_IMG_NO"/>
	   <result property="imagePath" column="IMG_PATH"/>
	   <result property="imageReName" column="IMG_RENAME"/>
	   <result property="imageOriginal" column="IMG_ORIGINAL"/>
	   <result property="imageOrder" column="IMG_ORDER"/>
	   <result property="reviewNo" column="REVIEW_NO"/>
</resultMap>

<!-- 전체 리뷰 수 조회 -->
<select id="getListCount" parameterType="_int" resultType="_int">
SELECT COUNT(*) FROM "REVIEW"
WHERE REVIEW_DEL_FL='N'
</select>

<!-- 전체 리뷰 목록 조회 -->
<select id="selectReviewList" resultMap="review_rm">
SELECT REVIEW_NO, RATING, REVIEW_CONTENT, MEMBER_NO, MEMBER_NICKNAME, MENU_NO, MENU_NAME,
	TO_CHAR(REVIEW_DATE, 'YYYY-MM-DD') REVIEW_DATE,
 	(SELECT COUNT(*) FROM "LIKE" L
	  WHERE L.REVIEW_NO = R.REVIEW_NO) LIKE_COUNT,
	(SELECT IMG_PATH || IMG_RENAME FROM REVIEW_IMG I
	WHERE IMG_ORDER =0
	AND I.REVIEW_NO = R.REVIEW_NO) THUMBNAIL
FROM "REVIEW" R
JOIN "MEMBER" USING(MEMBER_NO)
JOIN "ORDER_MENU" USING(ORDER_MENU_NO)
JOIN "MENU" USING(MENU_NO)
WHERE REVIEW_DEL_FL='N'
ORDER BY REVIEW_NO DESC
</select>

<!-- 특정 메뉴 리뷰 수 조회 -->
<select id="getMenuReviewListCount" parameterType="_int" resultType="_int">
SELECT COUNT(*) FROM "REVIEW"
JOIN ORDER_MENU USING(ORDER_MENU_NO)
WHERE MENU_NO = #{menuNo}
AND REVIEW_DEL_FL='N'
</select>

<!-- 특정 메뉴 리뷰 목록 조회 -->
<select id="selectMenuReviewList" resultMap="review_rm">
SELECT REVIEW_NO, RATING, REVIEW_CONTENT, MEMBER_NO, MEMBER_NICKNAME, MENU_NO, MENU_NAME,
	TO_CHAR(REVIEW_DATE, 'YYYY-MM-DD') REVIEW_DATE,
 	(SELECT COUNT(*) FROM "LIKE" L
	  WHERE L.REVIEW_NO = R.REVIEW_NO) LIKE_COUNT,
	(SELECT IMG_PATH || IMG_RENAME FROM REVIEW_IMG I
	WHERE IMG_ORDER =0
	AND I.REVIEW_NO = R.REVIEW_NO) THUMBNAIL
FROM "REVIEW" R
JOIN "MEMBER" USING(MEMBER_NO)
JOIN "ORDER_MENU" USING(ORDER_MENU_NO)
JOIN "MENU" USING(MENU_NO)
WHERE REVIEW_DEL_FL='N'
AND MENU_NO = #{menuNo}
ORDER BY REVIEW_NO DESC
</select>

<!-- 리뷰 상세 조회 -->
<select id="selectReviewDetail" resultMap="review_rm">
SELECT REVIEW_NO, RATING, REVIEW_CONTENT, MEMBER_NO, MEMBER_NICKNAME, MENU_NAME,
	TO_CHAR(REVIEW_DATE, 'YYYY-MM-DD') REVIEW_DATE,
 	(SELECT COUNT(*) FROM "LIKE" L
	  WHERE L.REVIEW_NO = R.REVIEW_NO) LIKE_COUNT,
	(SELECT IMG_PATH || IMG_RENAME FROM REVIEW_IMG I
	WHERE IMG_ORDER =0
	AND I.REVIEW_NO = R.REVIEW_NO) THUMBNAIL,
	(SELECT COUNT(*) FROM "LIKE" L WHERE L.REVIEW_NO = R.REVIEW_NO AND MEMBER_NO = #{memberNo}) LIKE_CHECK
FROM "REVIEW" R
JOIN "MEMBER" USING(MEMBER_NO)
JOIN "ORDER_MENU" USING(ORDER_MENU_NO)
JOIN "MENU" USING(MENU_NO)
WHERE REVIEW_DEL_FL='N'
AND REVIEW_NO = #{reviewNo}
</select>

<!-- 나의 리뷰 목록 조회 -->
<select id="selectMyReview" resultMap="review_rm">
SELECT REVIEW_NO, RATING, REVIEW_CONTENT, MEMBER_NICKNAME, MENU_NAME,
   TO_CHAR(REVIEW_DATE, 'YYYY-MM-DD') REVIEW_DATE,
    (SELECT COUNT(*) FROM "LIKE" L
     WHERE L.REVIEW_NO = R.REVIEW_NO) LIKE_COUNT,
   (SELECT IMG_PATH || IMG_RENAME FROM REVIEW_IMG I
   WHERE IMG_ORDER =0
   AND I.REVIEW_NO = R.REVIEW_NO) THUMBNAIL
FROM "REVIEW" R
JOIN "MEMBER" USING(MEMBER_NO)
JOIN "ORDER_MENU" USING(ORDER_MENU_NO)
JOIN "MENU" USING(MENU_NO)
WHERE REVIEW_DEL_FL='N'
AND MEMBER_NO = #{memberNo}
ORDER BY REVIEW_DATE DESC
</select>

<!-- 좋아요 여부 체크 -->
<select id="reviewLikeCheck" resultType="_int">
SELECT COUNT(*) FROM "LIKE"
WHERE REVIEW_NO = #{reviewNo}
AND MEMBER_NO = #{memberNo}
</select>

<!-- 좋아요 수 증가 -->
<insert id="reviewLikeUp">
INSERT INTO "LIKE"
VALUES (#{reviewNo}, #{memberNo})
</insert>

<!-- 좋아요 수 감소 -->
<delete id="reviewLikeDown">
DELETE FROM "LIKE"
WHERE REVIEW_NO =#{reviewNo}
AND MEMBER_NO=#{memberNo}
</delete>

<!-- 리뷰 삭제 -->
<update id="deleteReview">
UPDATE "REVIEW" SET
REVIEW_DEL_FL = 'Y'
WHERE REVIEW_NO=#{reviewNo}
</update>
</mapper>